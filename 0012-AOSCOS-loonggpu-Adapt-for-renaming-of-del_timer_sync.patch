From 301873790c4dfdcdd8d226658265b1b2aa308010 Mon Sep 17 00:00:00 2001
From: Xi Ruoyao <xry111@xry111.site>
Date: Sat, 21 Jun 2025 21:15:51 +0800
Subject: [PATCH 12/63] AOSCOS: loonggpu: Adapt for renaming of del_timer_sync
 to timer_delete_sync

Signed-off-by: Xi Ruoyao <xry111@xry111.site>
---
 conftest.sh                   | 15 +++++++++++++++
 loonggpu/loonggpu.Kbuild      |  1 +
 loonggpu/loonggpu_backlight.c |  4 ++--
 loonggpu/loonggpu_fence.c     |  2 +-
 4 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/conftest.sh b/conftest.sh
index bbc1beb..12c7089 100644
--- a/conftest.sh
+++ b/conftest.sh
@@ -2760,6 +2760,21 @@ compile_test() {
             compile_check_conftest "$CODE" "LG_DRM_DRIVER_TIMER_CONTAINER_OF" "" "types"
         ;;
 
+        timer_delete_sync)
+            #
+            # Determine whether del_timer_sync has been renamed to timer_delete_sync
+            #
+            # Changed by commit 8fa7292fee5c5240402371ea89ab285ec856c916
+			# ("treewide: Switch/rename to timer_delete[_sync]()")
+            #
+            CODE="
+            #include <linux/timer.h>
+
+            void *func = timer_delete_sync;"
+
+            compile_check_conftest "$CODE" "LG_DRM_DRIVER_TIMER_DELETE_SYNC" "" "types"
+        ;;
+
         uts_release)
             #
             # print the kernel's UTS_RELEASE string.
diff --git a/loonggpu/loonggpu.Kbuild b/loonggpu/loonggpu.Kbuild
index 92f52c2..3fed4a5 100644
--- a/loonggpu/loonggpu.Kbuild
+++ b/loonggpu/loonggpu.Kbuild
@@ -198,3 +198,4 @@ LG_CONFTEST_TYPE_COMPILE_TESTS += mmu_notifier_ops_has_free_notifier
 LG_CONFTEST_TYPE_COMPILE_TESTS += pwm_add_table
 LG_CONFTEST_TYPE_COMPILE_TESTS += drm_sched_init_has_struct_arg
 LG_CONFTEST_TYPE_COMPILE_TESTS += timer_container_of
+LG_CONFTEST_TYPE_COMPILE_TESTS += timer_delete_sync
diff --git a/loonggpu/loonggpu_backlight.c b/loonggpu/loonggpu_backlight.c
index 1546c12..8aae954 100644
--- a/loonggpu/loonggpu_backlight.c
+++ b/loonggpu/loonggpu_backlight.c
@@ -119,7 +119,7 @@ static void timer_power_ctrl_callback(struct timer_list *timer)
 	if (loonggpu_lcd_ctrl_open_detect(open_timer->ls_bl) ==
 			open_timer->ls_bl->lcd_ctrl->gpio_detect_open_polarity) {
 		loonggpu_lcd_ctrl_hw_action(open_timer->ls_bl, true);
-		del_timer(&open_timer->timer);
+		lg_drm_timer_delete(&open_timer->timer);
 		open_timer->running = false;
 		return;
 	}
@@ -138,7 +138,7 @@ static void loonggpu_lcd_ctrl_hw_action_timer(struct loonggpu_backlight *ls_bl,
 		ls_bl->lcd_ctrl->open_timer.running = true;
 	} else {
 		if (ls_bl->lcd_ctrl->open_timer.running)
-			del_timer(&ls_bl->lcd_ctrl->open_timer.timer);
+			lg_drm_timer_delete(&ls_bl->lcd_ctrl->open_timer.timer);
 		else
 			loonggpu_lcd_ctrl_hw_action(ls_bl, false);
 		ls_bl->lcd_ctrl->open_timer.running = false;
diff --git a/loonggpu/loonggpu_fence.c b/loonggpu/loonggpu_fence.c
index b675e7b..3531680 100644
--- a/loonggpu/loonggpu_fence.c
+++ b/loonggpu/loonggpu_fence.c
@@ -471,7 +471,7 @@ void loonggpu_fence_driver_fini(struct loonggpu_device *adev)
 		loonggpu_irq_put(adev, ring->fence_drv.irq_src,
 			       ring->fence_drv.irq_type);
 		drm_sched_fini(&ring->sched);
-		del_timer_sync(&ring->fence_drv.fallback_timer);
+		lg_drm_timer_delete_sync(&ring->fence_drv.fallback_timer);
 		for (j = 0; j <= ring->fence_drv.num_fences_mask; ++j)
 			dma_fence_put(ring->fence_drv.fences[j]);
 		kfree(ring->fence_drv.fences);
-- 
2.52.0

