From 0bdf30e41cd440d5f34c1a5c8ab1cbf6602dfd41 Mon Sep 17 00:00:00 2001
From: Xi Ruoyao <xry111@xry111.site>
Date: Fri, 15 Aug 2025 20:24:55 +0800
Subject: [PATCH 36/63] loonggpu: Pass along the format info from .fb_create()
 to drm_helper_mode_fill_fb_struct()

Signed-off-by: Xi Ruoyao <xry111@xry111.site>
---
 include/loonggpu_mode.h     |  2 ++
 loonggpu/loonggpu_display.c |  8 +++++++-
 loonggpu/loonggpu_fb.c      | 28 +++++++++++++++++++---------
 3 files changed, 28 insertions(+), 10 deletions(-)

diff --git a/include/loonggpu_mode.h b/include/loonggpu_mode.h
index 96bd1fb..45cb2e0 100644
--- a/include/loonggpu_mode.h
+++ b/include/loonggpu_mode.h
@@ -13,6 +13,7 @@
 #include "loonggpu_irq.h"
 #include "loonggpu_dc_irq.h"
 #include "loonggpu_dc_interface.h"
+#include "loonggpu_display.h"
 
 struct loonggpu_bo;
 struct loonggpu_device;
@@ -157,6 +158,7 @@ int loonggpu_display_get_crtc_scanoutpos(struct drm_device *dev,
 
 int loonggpu_display_framebuffer_init(struct drm_device *dev,
 				   struct loonggpu_framebuffer *rfb,
+				   LOONGGPU_FB_CREATE_DRM_FORMAT_INFO
 				   const struct drm_mode_fb_cmd2 *mode_cmd,
 				   struct drm_gem_object *obj);
 
diff --git a/loonggpu/loonggpu_display.c b/loonggpu/loonggpu_display.c
index caa211c..1a7e727 100644
--- a/loonggpu/loonggpu_display.c
+++ b/loonggpu/loonggpu_display.c
@@ -288,6 +288,7 @@ uint32_t loonggpu_display_supported_domains(struct loonggpu_device *adev)
 
 int loonggpu_display_framebuffer_init(struct drm_device *dev,
 				    struct loonggpu_framebuffer *rfb,
+				    LOONGGPU_FB_CREATE_DRM_FORMAT_INFO
 				    const struct drm_mode_fb_cmd2 *mode_cmd,
 				    struct drm_gem_object *obj)
 {
@@ -295,7 +296,7 @@ int loonggpu_display_framebuffer_init(struct drm_device *dev,
 	rfb->base.obj[0] = obj;
 
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
-	drm_helper_mode_fill_fb_struct(dev, &rfb->base, NULL, mode_cmd);
+	drm_helper_mode_fill_fb_struct(dev, &rfb->base, info, mode_cmd);
 #else
 	drm_helper_mode_fill_fb_struct(dev, &rfb->base, mode_cmd);
 #endif
@@ -341,7 +342,12 @@ loonggpu_display_user_framebuffer_create(struct drm_device *dev,
 		return ERR_PTR(-ENOMEM);
 	}
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+	ret = loonggpu_display_framebuffer_init(dev, loonggpu_fb, info, mode_cmd, obj);
+#else
 	ret = loonggpu_display_framebuffer_init(dev, loonggpu_fb, mode_cmd, obj);
+#endif
+
 	if (ret) {
 		kfree(loonggpu_fb);
 		lg_drm_gem_object_put(obj);
diff --git a/loonggpu/loonggpu_fb.c b/loonggpu/loonggpu_fb.c
index 96a9aca..61303a3 100644
--- a/loonggpu/loonggpu_fb.c
+++ b/loonggpu/loonggpu_fb.c
@@ -108,12 +108,12 @@ int loonggpu_align_pitch(struct loonggpu_device *adev, int width, int cpp, bool
 }
 
 static int loonggpufb_create_pinned_object(struct drm_fb_helper *fb_helper,
-					 struct drm_mode_fb_cmd2 *mode_cmd,
-					 struct drm_gem_object **gobj_p)
+					LOONGGPU_FB_CREATE_DRM_FORMAT_INFO
+					struct drm_mode_fb_cmd2 *mode_cmd,
+					struct drm_gem_object **gobj_p)
 {
 	struct loonggpu_device *adev = fb_helper->dev->dev_private;
 	struct drm_gem_object *gobj = NULL;
-	const struct drm_format_info *info;
 	struct loonggpu_bo *abo = NULL;
 	bool fb_tiled = false; /* useful for testing */
 	u32 tiling_flags = 0, domain;
@@ -122,11 +122,9 @@ static int loonggpufb_create_pinned_object(struct drm_fb_helper *fb_helper,
 	int height = mode_cmd->height;
 	u32 cpp;
 
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
-	info = drm_get_format_info(adev->ddev, mode_cmd->pixel_format,
-				   mode_cmd->modifier[0]);
-#else
-	info = drm_get_format_info(adev->ddev, mode_cmd);
+#if LINUX_VERSION_CODE < KERNEL_VERSION(6, 17, 0)
+	const struct drm_format_info *info =
+		drm_get_format_info(adev->ddev, mode_cmd);
 #endif
 	cpp = info->cpp[0];
 
@@ -213,7 +211,16 @@ int loonggpu_driver_fbdev_probe(struct drm_fb_helper *helper,
 	mode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,
 							  sizes->surface_depth);
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+	const struct drm_format_info *format_info =
+		drm_get_format_info(adev->ddev, mode_cmd.pixel_format,
+				    mode_cmd.modifier[0]);
+	ret = loonggpufb_create_pinned_object(helper, format_info, &mode_cmd,
+					   &gobj);
+#else
 	ret = loonggpufb_create_pinned_object(helper, &mode_cmd, &gobj);
+#endif
+
 	if (ret) {
 		DRM_ERROR("failed to create fbcon object %d\n", ret);
 		return ret;
@@ -228,7 +235,10 @@ int loonggpu_driver_fbdev_probe(struct drm_fb_helper *helper,
 	}
 
 	ret = loonggpu_display_framebuffer_init(adev->ddev, to_loonggpu_framebuffer(fb),
-					      &mode_cmd, gobj);
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 17, 0)
+					     format_info,
+#endif
+					     &mode_cmd, gobj);
 	if (ret) {
 		DRM_ERROR("failed to initialize framebuffer %d\n", ret);
 		goto err_kfree;
-- 
2.52.0

