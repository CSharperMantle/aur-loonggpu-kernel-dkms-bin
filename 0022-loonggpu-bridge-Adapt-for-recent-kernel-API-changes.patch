From 95f25d6bd8769307007a69dce5cf2957315c0089 Mon Sep 17 00:00:00 2001
From: Xi Ruoyao <xry111@xry111.site>
Date: Thu, 4 Dec 2025 18:31:22 +0800
Subject: [PATCH 22/63] loonggpu: bridge: Adapt for recent kernel API changes

Signed-off-by: Xi Ruoyao <xry111@xry111.site>
---
 loonggpu-bridge/bridge_phy.c | 13 +++++++++++--
 loonggpu-bridge/bridge_phy.h |  6 ++++++
 2 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/loonggpu-bridge/bridge_phy.c b/loonggpu-bridge/bridge_phy.c
index c83f234..14215c2 100644
--- a/loonggpu-bridge/bridge_phy.c
+++ b/loonggpu-bridge/bridge_phy.c
@@ -130,7 +130,7 @@ static bool is_resolution_valid(struct panel_resource *panel_resource, const str
 
 static enum drm_mode_status
 bridge_phy_connector_mode_valid(struct drm_connector *connector,
-				struct drm_display_mode *mode)
+				MODE_VALID_CONST struct drm_display_mode *mode)
 {
 	struct loonggpu_device *adev = connector->dev->dev_private;
 	struct loonggpu_bridge_phy *phy =
@@ -307,7 +307,16 @@ void bridge_phy_mode_set(struct loonggpu_bridge_phy *phy,
 	__bridge_phy_mode_set(phy, mode, adj_mode);
 }
 
-static int bridge_phy_attach (lg_bridge_phy_attach_args)
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 16, 0)
+#define lg_bridge_phy_attach_args_1 \
+	struct drm_bridge *bridge, \
+	struct drm_encoder *encoder, \
+	enum drm_bridge_attach_flags flags
+#else
+#define lg_bridge_phy_attach_args_1 lg_bridge_phy_attach_args
+#endif
+
+static int bridge_phy_attach (lg_bridge_phy_attach_args_1)
 {
 	struct loonggpu_bridge_phy *phy = to_bridge_phy(bridge);
 	struct loonggpu_connector *lconnector;
diff --git a/loonggpu-bridge/bridge_phy.h b/loonggpu-bridge/bridge_phy.h
index 42f36e6..054d4ea 100644
--- a/loonggpu-bridge/bridge_phy.h
+++ b/loonggpu-bridge/bridge_phy.h
@@ -21,6 +21,12 @@
 #define to_bridge_phy(drm_bridge)                                            \
 	container_of(drm_bridge, struct loonggpu_bridge_phy, bridge)
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 15, 0)
+#define MODE_VALID_CONST const
+#else
+#define MODE_VALID_CONST
+#endif
+
 struct loonggpu_bridge_phy;
 
 struct loonggpu_dc_bridge {
-- 
2.52.0

