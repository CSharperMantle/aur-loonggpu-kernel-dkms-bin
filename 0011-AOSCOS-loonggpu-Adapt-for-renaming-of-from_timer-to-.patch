From 3d0e8d9ebc4a3869ede63c698ac0fe0c4c4d6bbb Mon Sep 17 00:00:00 2001
From: Xi Ruoyao <xry111@xry111.site>
Date: Sat, 21 Jun 2025 21:07:26 +0800
Subject: [PATCH 11/63] AOSCOS: loonggpu: Adapt for renaming of from_timer to
 timer_container_of

Signed-off-by: Xi Ruoyao <xry111@xry111.site>
---
 conftest.sh               | 17 +++++++++++++++++
 include/loonggpu_helper.h | 14 ++++++++++++++
 loonggpu/loonggpu.Kbuild  |  1 +
 loonggpu/loonggpu_fence.c |  2 +-
 4 files changed, 33 insertions(+), 1 deletion(-)

diff --git a/conftest.sh b/conftest.sh
index 18b64d1..bbc1beb 100644
--- a/conftest.sh
+++ b/conftest.sh
@@ -2743,6 +2743,23 @@ compile_test() {
             compile_check_conftest "$CODE" "LG_DRM_DRIVER_SYNCOBJ_TIMELINE_PRESENT" "" "types"
         ;;
 
+        timer_container_of)
+            #
+            # Determine whether from_timer is renamed to timer_container_of.
+            #
+            # Changed by commit 41cb08555c4164996d67c78b3bf1c658075b75f1
+			# ("treewide, timers: Rename from_timer() to timer_container_of()")
+            #
+            CODE="
+            #include <linux/timer.h>
+
+            #ifndef timer_container_of
+            #error no timer_container_of
+            #endif"
+
+            compile_check_conftest "$CODE" "LG_DRM_DRIVER_TIMER_CONTAINER_OF" "" "types"
+        ;;
+
         uts_release)
             #
             # print the kernel's UTS_RELEASE string.
diff --git a/include/loonggpu_helper.h b/include/loonggpu_helper.h
index 91ff130..a761b3a 100644
--- a/include/loonggpu_helper.h
+++ b/include/loonggpu_helper.h
@@ -1254,6 +1254,20 @@ static inline void lg_ttm_placement_set_num_busy(struct ttm_placement *placement
 #define lg_drm_driver_set_lastclose
 #endif
 
+#if defined(LG_DRM_DRIVER_TIMER_CONTAINER_OF)
+#define lg_drm_timer_container_of timer_container_of
+#else
+#define lg_drm_timer_container_of from_timer
+#endif
+
+#if defined(LG_DRM_DRIVER_TIMER_DELETE_SYNC)
+#define lg_drm_timer_delete_sync timer_delete_sync
+#define lg_drm_timer_delete timer_delete
+#else
+#define lg_drm_timer_delete_sync del_timer_sync
+#define lg_drm_timer_delete del_timer
+#endif
+
 #if defined(VERIFY_WRITE)
 #define lg_access_ok(type, addr, size) access_ok(type, addr, size)
 #else
diff --git a/loonggpu/loonggpu.Kbuild b/loonggpu/loonggpu.Kbuild
index 4fa5b00..92f52c2 100644
--- a/loonggpu/loonggpu.Kbuild
+++ b/loonggpu/loonggpu.Kbuild
@@ -197,3 +197,4 @@ LG_CONFTEST_TYPE_COMPILE_TESTS += mode_config_has_fb_modifiers
 LG_CONFTEST_TYPE_COMPILE_TESTS += mmu_notifier_ops_has_free_notifier
 LG_CONFTEST_TYPE_COMPILE_TESTS += pwm_add_table
 LG_CONFTEST_TYPE_COMPILE_TESTS += drm_sched_init_has_struct_arg
+LG_CONFTEST_TYPE_COMPILE_TESTS += timer_container_of
diff --git a/loonggpu/loonggpu_fence.c b/loonggpu/loonggpu_fence.c
index b9f69b6..b675e7b 100644
--- a/loonggpu/loonggpu_fence.c
+++ b/loonggpu/loonggpu_fence.c
@@ -255,7 +255,7 @@ void loonggpu_fence_process(struct loonggpu_ring *ring)
  */
 static void loonggpu_fence_fallback(struct timer_list *t)
 {
-	struct loonggpu_ring *ring = from_timer(ring, t,
+	struct loonggpu_ring *ring = lg_drm_timer_container_of(ring, t,
 					      fence_drv.fallback_timer);
 
 	loonggpu_fence_process(ring);
-- 
2.52.0

